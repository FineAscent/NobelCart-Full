<!-- checkout.html this is for the checkout but loads only on the phone through the scan qr -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="checkout.css" />
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body class="checkout page-opacity-0">
  <div class="checkout-wrapper">
    <div class="checkout-card">
      <div class="checkout-left">
        <div class="checkout-header">
          <button class="back-btn" id="checkout-back-btn">
            <span class="back-icon">‚Üê</span>
            <span class="back-text">Back</span>
          </button>
        </div>

        <div class="custom-inputs">
          <div class="input-group name-group">
            <input type="text" placeholder="Name" class="custom-input full-name" id="checkout-full-name" readonly>
          </div>

          <div class="card-info-label">Payment Details</div>

          <div id="checkout-mount">
            <!-- Stripe Embedded Checkout will mount here -->
            <div style="text-align: center; color: #6b7280; margin-top: 40px;">
              Initializing checkout...
            </div>
          </div>
        </div>
      </div>

      <div class="checkout-right">
        <h2 class="checkout-title">Order Summary</h2>

        <div class="cart-items-container">
          <div class="cart-items">
            <!-- Cart items will be rendered here by site.js -->
          </div>
        </div>

        <div class="checkout-footer">
          <div class="subtotal">
            <span class="subtotal-label">Total:</span>
            <span class="subtotal-amount">$0.00</span>
          </div>
          <button class="checkout-btn">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    // Auto-fill user name from signed-in profile
    (async () => {
      try {
        if (!window.sb) return;
        const { data } = await window.sb.auth.getSession();
        if (!data?.session) return;

        const { data: userData } = await window.sb.auth.getUser();
        const email = userData?.user?.email || '';

        // Try to get name from user metadata or email
        const userMeta = userData?.user?.user_metadata || {};
        // Prioritize full_name, fallback to first+last, or email part
        let fullName = userMeta.full_name || '';

        if (!fullName) {
          const first = userMeta.first_name || userMeta.name || '';
          const last = userMeta.last_name || '';
          if (first || last) {
            fullName = `${first} ${last}`.trim();
          }
        }

        // If still no name, try to extract from email
        if (!fullName && email) {
          const emailPart = email.split('@')[0];
          // Simple heuristic to capitalize email part
          fullName = emailPart.charAt(0).toUpperCase() + emailPart.slice(1);
        }

        // Fill the input field
        const nameInput = document.getElementById('checkout-full-name');

        if (nameInput && fullName) {
          nameInput.value = fullName;
          nameInput.style.color = '#333';
        }
      } catch (e) {
        console.error('Failed to auto-fill name:', e);
      }
    })();
  </script>
  <script src="site.js?v=8"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const backBtn = document.getElementById('checkout-back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          document.body.classList.add('page-transition-fade-out');
          setTimeout(() => {
            // Force navigation to index.html (defaults to OpenSearch/Main view)
            window.location.href = 'index.html';
          }, 500);
        });
      }
    });
  </script>
</body>

</html>