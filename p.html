<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecting to Payment...</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f5f5f5; color: #333; }
    .msg { text-align: center; padding: 20px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #8b7355; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="msg">
    <div class="spinner"></div>
    <div id="status">Loading payment...</div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="site.js"></script>
  <script>
    (async () => {
      const statusEl = document.getElementById('status');
      const params = new URLSearchParams(window.location.search);
      const sid = params.get('s'); // short param for session id
      const code = params.get('c'); // even shorter param for lookup code
      
      if (!sid && !code) {
        statusEl.textContent = 'Invalid payment link.';
        return;
      }

      try {
        let url = null;

        // Strategy 1: Realtime Handshake (if code 'c' is present)
        if (code && window.sb) {
          statusEl.textContent = 'Connecting...';
          try {
            url = await new Promise((resolve, reject) => {
              const channel = window.sb.channel(`checkout_handshake_${code}`, { config: { broadcast: { ack: true } } });
              const timeout = setTimeout(() => {
                window.sb.removeChannel(channel);
                resolve(null); // Fallback to DB/API lookup if no peer response
              }, 2500);

              channel
                .on('broadcast', { event: 'response_url' }, (payload) => {
                  clearTimeout(timeout);
                  window.sb.removeChannel(channel);
                  if (payload.payload && payload.payload.url) resolve(payload.payload.url);
                  else resolve(null);
                })
                .subscribe(async (status) => {
                  if (status === 'SUBSCRIBED') {
                    await channel.send({ type: 'broadcast', event: 'request_url', payload: {} });
                  }
                });
            });
          } catch (e) {
            console.error('Handshake error', e);
          }
        }

        // Strategy 2: API Lookup (DB fallback or Session ID)
        if (!url) {
          statusEl.textContent = 'Loading payment...';
          let data = null;
          const payload = code ? { action: 'resolve', code } : { action: 'status', session_id: sid };

          if (window.sb && window.sb.functions && window.sb.functions.invoke) {
             const { data: d, error } = await window.sb.functions.invoke('stripe-create-session', {
              body: payload
            });
            if (error) throw error;
            data = d;
          } else {
             const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || '';
             const res = await fetch(API_BASE + '/stripe/create-session', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify(payload)
             });
             if (!res.ok) throw new Error('API error');
             data = await res.json();
          }
          url = data?.url;
        }

        if (url) {
          statusEl.textContent = 'Redirecting to Stripe...';
          window.location.href = url;
        } else {
          throw new Error('No payment URL found');
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Failed to load payment. Please try scanning again.';
      }
    })();
  </script>
</body>
</html>
