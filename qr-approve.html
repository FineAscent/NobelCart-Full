<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Approve Login</title>
  <style>
    /* Mobile-only, black & white, minimal UI */
    html, body { height: 100%; background:#fff; color:#000; }
    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    body.signin { margin:0; overflow:hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .container { height:100%; display:flex; align-items:center; justify-content:center; padding: 12px; }
    .auth-wrapper { width:100%; max-width:480px; }
    .auth-card { width: 100%; border-radius: 16px; background:#fff; padding: 20px; border: none; }
    .logo-slot { width:100%; display:flex; align-items:center; justify-content:center; height: 64px; margin-bottom: 6px; }
    .logo-slot img { max-height: 56px; max-width: 82%; width: auto; height: auto; object-fit: contain; image-rendering: auto; }
    .auth-title { font-size: 22px; margin: 0 0 6px 0; text-align:center; font-weight: 600; }
    .auth-subtitle { font-size: 14px; margin: 0 0 14px 0; text-align:center; }
    .auth-field { margin-top: 12px; }
    .auth-label { font-size: 13px; display:block; margin-bottom:8px; }
    .auth-input { width:100%; height:48px; font-size:16px; padding: 10px 12px; border-radius:12px; border:1px solid #000; background:#fff; color:#000; }
    .auth-input::placeholder { color:#000; opacity:0.4; }
    .auth-input.valid { border-color: #16a34a; /* green */ }
    .auth-input.invalid { border-color: #dc2626; /* red */ }
    .helper { font-size: 12px; margin-top: 6px; min-height: 16px; }
    .helper.ok { color: #16a34a; }
    .helper.err { color: #dc2626; }
    .auth-button { width:100%; height:48px; font-size:16px; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid #000; background:#000; color:#fff; }
    #approve-btn { height:48px; font-size:16px; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid #000; background:#000; color:#fff; }
    .btn { display:flex; align-items:center; justify-content:center; }
    .auth-input-wrap { position: relative; display:flex; align-items:center; }
    .toggle-password-btn { position:absolute; right:8px; height:34px; padding: 0 10px; border:1px solid #000; border-radius:8px; background:#fff; color:#000; cursor:pointer; font-size:12px; }
    .auth-error { text-align:center; }
    /* Modal styles (black & white) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; padding: 16px; }
    .modal { width:100%; max-width: 420px; background:#fff; border-radius: 16px; border: 1px solid #000; }
    .modal-header { padding: 14px 16px; font-weight: 600; border-bottom: 1px solid #000; text-align:center; }
    .modal-body { padding: 12px 16px; }
    .modal-actions { display:flex; gap:8px; padding: 12px 16px; border-top: 1px solid #000; }
    .btn-primary { background:#000; color:#fff; border:1px solid #000; border-radius:12px; height:44px; padding:0 14px; }
    .btn-secondary { background:#fff; color:#000; border:1px solid #000; border-radius:12px; height:44px; padding:0 14px; }
    /* Compact heights: keep everything in view (no scroll) */
    @media (max-height: 640px) {
      .auth-card { padding: 16px; }
      .auth-title { font-size: 20px; margin-bottom: 4px; }
      .auth-subtitle { font-size: 13px; margin-bottom: 10px; }
      .auth-field { margin-top: 10px; }
    }
  </style>
</head>
<body class="signin">
  <div class="container">
    <div class="auth-wrapper" role="main">
      <div class="auth-card" aria-labelledby="approve-title">
        <h1 id="approve-title" class="auth-title">Approve Login</h1>
        <p class="auth-subtitle">Sign in on your phone to approve the desktop session.</p>

        <div id="status" class="auth-error" style="display:none;"></div>

        <form id="phone-signin-form" class="auth-form" novalidate autocomplete="on">
          <div class="auth-field">
            <label class="auth-label" for="email">Email</label>
            <input id="email" class="auth-input" type="email" name="username" placeholder="you@example.com" autocomplete="username" inputmode="email" autocapitalize="none" required />
            <div id="email-help" class="helper" aria-live="polite"></div>
          </div>
          <div class="auth-field">
            <label class="auth-label" for="password">Password</label>
            <div class="auth-input-wrap">
              <input id="password" class="auth-input" type="password" name="password" placeholder="••••••••" autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false" required style="padding-right:84px;" />
              <button type="button" id="toggle-password-phone" class="toggle-password-btn" aria-label="Show password">Show</button>
            </div>
            <div id="password-help" class="helper" aria-live="polite"></div>
          </div>
          <div style="height:14px;"></div>
          <button type="submit" class="auth-button">Sign In</button>
        </form>

        <div style="margin-top: 12px; text-align:center;">
          <button id="approve-btn" class="auth-button" style="display:none;">Approve and Send</button>
        </div>

        <p id="hint" style="margin-top:10px; color:#000; font-size:13px; text-align:center;"></p>
      </div>
    </div>
  </div>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script>
    function haptic(pattern){
      try {
        if (navigator.vibrate) {
          navigator.vibrate(pattern || [18]);
        }
      } catch(_){}
    }
    // Lightweight modal for success message
    function ensureModalRoot(){
      if (!document.querySelector('#modal-root')){
        const root = document.createElement('div');
        root.id = 'modal-root';
        document.body.appendChild(root);
      }
    }
    function showSuccessModal(msg){
      ensureModalRoot();
      const root = document.querySelector('#modal-root');
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-header">Success</div>
        <div class="modal-body">
          <div style="text-align:center; font-size:15px;">${(msg||'Login complete.').replace(/</g,'&lt;')}</div>
        </div>
        <div class="modal-actions" style="justify-content:center;">
          <button class="btn btn-primary" id="ok-close">Close</button>
        </div>`;
      overlay.appendChild(modal);
      root.appendChild(overlay);
      const closeNow = ()=>{ try{ root.removeChild(overlay);}catch(_){} };
      modal.querySelector('#ok-close')?.addEventListener('click', closeNow);
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeNow(); });
      return { close: closeNow };
    }

    function cryptoSupported(){
      return !!(window.isSecureContext && window.crypto && window.crypto.subtle);
    }
    // Helpers: parse query, crypto, realtime broadcast
    function getQuery() {
      const p = new URLSearchParams(location.search);
      return { code: p.get('code') || '', secret: p.get('secret') || '' };
    }
    function showError(msg){
      const s = document.getElementById('status');
      s.textContent = msg;
      s.style.display = 'block';
    }
    function hideError(){ const s=document.getElementById('status'); s.style.display='none'; }

    async function deriveKey(secret){
      if (!cryptoSupported()) throw new Error('Secure context required: open this link over HTTPS so we can encrypt.');
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(secret), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name:'PBKDF2', salt: enc.encode('nc-qr-salt'), iterations: 100000, hash:'SHA-256' }, keyMaterial, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
    }
    async function encryptJson(secret, obj){
      if (!cryptoSupported()) throw new Error('Secure context required: open this link over HTTPS so we can encrypt.');
      const key = await deriveKey(secret);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder();
      const data = enc.encode(JSON.stringify(obj));
      const ct = new Uint8Array(await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, data));
      return { iv: btoa(String.fromCharCode(...iv)), ct: btoa(String.fromCharCode(...ct)) };
    }

    async function ensureSignedIn(){
      if (!window.sb) throw new Error('Auth not initialized');
      const { data } = await window.sb.auth.getSession();
      if (data && data.session && data.session.user) return data.session;
      // Not signed in yet, wait for form submission
      return null;
    }

    async function sendApproval(code, secret){
      try{
        hideError();
        if (!window.sb) throw new Error('Auth not initialized');
        const { data, error } = await window.sb.auth.getSession();
        if (error) throw error;
        const session = data && data.session;
        if (!session) throw new Error('Not signed in');
        const access_token = session.access_token;
        const refresh_token = session.refresh_token;
        if (!access_token || !refresh_token) throw new Error('Missing session tokens');

        const payload = await encryptJson(secret, { access_token, refresh_token });
        const channel = window.sb.channel('qr_login_' + code, { config: { broadcast: { ack: true } } });
        await channel.subscribe();
        const ok = await channel.send({ type: 'broadcast', event: 'login_session', payload });
        if (!ok) throw new Error('Failed to send approval');
        haptic([12, 30, 22]);
        document.getElementById('hint').textContent = 'Approval sent. You can close this page.';
        // Show success popup and attempt to close this tab after a short delay
        try {
          showSuccessModal('Login complete. NobelCart is ready.');
        } catch (_) {}
        // Try several strategies to close the tab (may be blocked by browser policies)
        setTimeout(() => {
          // Replace history then try to close
          try { history.replaceState(null, '', '/'); } catch(_){}
          try { window.open('', '_self'); } catch(_){}
          try { window.close(); } catch(_){}
        }, 700);
        // Also hide the approve button to avoid duplicate sends
        try { document.getElementById('approve-btn').style.display = 'none'; } catch(_){}
      }catch(e){
        showError(e.message || 'Failed to approve.');
      }
    }

    // Wire up form and approve button
    (async function(){
      const { code, secret } = getQuery();
      const approveBtn = document.getElementById('approve-btn');
      const form = document.getElementById('phone-signin-form');
      const hint = document.getElementById('hint');
      const emailInput = document.getElementById('email');
      const emailHelp = document.getElementById('email-help');
      const passwordInput = document.getElementById('password');
      const passwordHelp = document.getElementById('password-help');

      if (!code || !secret){
        showError('Invalid QR link.');
        form.style.display = 'none';
        return;
      }

      if (!cryptoSupported()){
        showError('Your browser does not provide Web Crypto in this context. On iOS Safari this happens over plain HTTP. Please use an HTTPS URL (e.g., via a temporary tunnel) and open this link again.');
        hint.textContent = 'Option A: Use an HTTPS tunnel (Cloudflare Tunnel, ngrok) and re-scan. Option B: Open the desktop site on your phone and sign in directly.';
      } else {
        hideError();
        hint.textContent = 'After signing in, tap "Approve and Send" to finish.';
      }

      // If already signed in on phone, show approve button directly
      try{
        const sess = await ensureSignedIn();
        if (sess){ approveBtn.style.display = 'inline-block'; }
      } catch (e) { /* ignore */ }

      function isValidEmail(v){
        // Simple RFC-like check
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
      }
      function isStrongPassword(v){
        // Basic rule: at least 8 chars
        return typeof v === 'string' && v.length >= 8;
      }
      function setValid(el, helpEl, ok, okMsg, errMsg){
        if (ok){
          el.classList.add('valid');
          el.classList.remove('invalid');
          if (helpEl){ helpEl.textContent = okMsg || ''; helpEl.className = 'helper ok'; }
        } else {
          el.classList.add('invalid');
          el.classList.remove('valid');
          if (helpEl){ helpEl.textContent = errMsg || ''; helpEl.className = 'helper err'; }
        }
      }

      emailInput.addEventListener('input', ()=>{
        const val = emailInput.value.trim();
        if (!val){
          emailInput.classList.remove('valid','invalid');
          emailHelp.textContent = '';
          emailHelp.className = 'helper';
          return;
        }
        const ok = isValidEmail(val);
        setValid(emailInput, emailHelp, ok, 'Looks good.', 'Enter a valid email.');
      });

      passwordInput.addEventListener('input', ()=>{
        const val = passwordInput.value;
        if (!val){
          passwordInput.classList.remove('valid','invalid');
          passwordHelp.textContent = '';
          passwordHelp.className = 'helper';
          return;
        }
        const ok = isStrongPassword(val);
        setValid(passwordInput, passwordHelp, ok, 'Strong enough.', 'Use at least 8 characters.');
      });

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        hideError();
        try{
          const email = emailInput.value.trim();
          const password = passwordInput.value.trim();
          if (!email || !password) { showError('Enter email and password.'); return; }
          // Validate before submit
          const emailOk = isValidEmail(email);
          const passOk = isStrongPassword(password);
          setValid(emailInput, emailHelp, emailOk, 'Looks good.', 'Enter a valid email.');
          setValid(passwordInput, passwordHelp, passOk, 'Strong enough.', 'Use at least 8 characters.');
          if (!emailOk || !passOk) { return; }
          const { data, error } = await window.sb.auth.signInWithPassword({ email, password });
          if (error) throw error;
          approveBtn.style.display = 'inline-block';
          hint.textContent = 'Signed in. Tap "Approve and Send" to finish.';
          haptic([10]);
        }catch(err){
          showError(err.message || 'Sign-in failed.');
        }
      });

      // Show/Hide password toggle for phone
      (function(){
        const btn = document.getElementById('toggle-password-phone');
        const input = document.getElementById('password');
        if (!btn || !input) return;
        btn.addEventListener('click', ()=>{
          const isPw = input.type === 'password';
          input.type = isPw ? 'text' : 'password';
          btn.textContent = isPw ? 'Hide' : 'Show';
          btn.setAttribute('aria-label', isPw ? 'Hide password' : 'Show password');
        });
      })();

      approveBtn.addEventListener('click', async ()=>{
        await sendApproval(code, secret);
      });
    })();
  </script>
</body>
</html>
