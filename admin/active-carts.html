<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • Active Carts</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body class="refunds-standalone">
  <style>
    /* Shares the simple centered layout used by other admin views */
    body.refunds-standalone { background: #f7fafc; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .ac-wrap { max-width: 1100px; width: 100%; padding: 24px 16px; }
    .ac-title { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 16px; }
    .ac-card { background:#ffffff; border:1px solid #e5e7eb; border-radius: 12px; padding:16px; }
    .ac-card + .ac-card { margin-top: 14px; }
    .ac-subtle { color:#6b7280; }
    .ac-table { width: 100%; border-collapse: collapse; }
    .ac-table th, .ac-table td { text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb; vertical-align: top; }
    .status-pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .pill-active { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .pill-inactive { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .toolbar { display:flex; align-items:center; justify-content: space-between; gap:12px; margin-bottom: 8px; flex-wrap: wrap; }
    .toolbar .btn { background:#efefef; border:1px solid #e5e7eb; padding:6px 10px; border-radius: 8px; cursor:pointer; text-decoration:none; color:#111827; }
    .toolbar .btn:hover { background:#e9e9e9; }
  </style>

  <div class="ac-wrap">
    <div class="ac-title">Active Carts</div>

    <div class="ac-card">
      <div class="toolbar">
        <div class="ac-subtle">Status is derived from Supabase authentication: users with an active session show as Active. Signed-out users show as Inactive.</div>
        <div style="display:flex; gap:8px;">
          <a class="btn" href="./index.html">← Back to Admin</a>
          <button id="refresh-carts" class="btn" type="button">Refresh</button>
        </div>
      </div>

      <table class="ac-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Status</th>
            <th>Last Seen</th>
            <th>Items</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="active-carts-body">
          <tr>
            <td colspan="5" class="ac-subtle" style="padding:16px;">Loading carts…</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Supabase (for auth + functions) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- App config (creates window.sb if supabase is available) -->
  <script src="../config.js"></script>
  <!-- Route guard: require active session to access admin -->
  <script>
    (async () => {
      try {
        if (!window.sb) return (window.location.href = '../signin.html');
        const { data, error } = await window.sb.auth.getSession();
        const session = data && data.session;
        if (error || !session) {
          try { await window.sb.auth.signOut({ scope: 'local' }); } catch {}
          return (window.location.href = '../signin.html');
        }
      } catch (e) {
        try { await window.sb.auth.signOut({ scope: 'local' }); } catch {}
        return (window.location.href = '../signin.html');
      }
    })();
  </script>
  <!-- Placeholder logic: wiring to be implemented later -->
  <script>
    const tbody = document.getElementById('active-carts-body');
    const btn = document.getElementById('refresh-carts');

    function fmt(ts) {
      try { return new Date(ts).toLocaleString(); } catch { return '—'; }
    }

    async function renderCarts() {
      // Require admin to be signed in, but actives are not tied to admin identity
      if (!window.sb) {
        tbody.innerHTML = `<tr><td colspan="5" class="ac-subtle" style="padding:16px;">No carts active right now</td></tr>`;
        return;
      }
      const { data: sess } = await window.sb.auth.getSession();
      if (!sess?.session) {
        tbody.innerHTML = `<tr><td colspan="5" class="ac-subtle" style="padding:16px;">No carts active right now</td></tr>`;
        return;
      }

      try {
        const { data: profiles, error } = await window.sb
          .from('profiles')
          .select('id, email, updated_at, active')
          .eq('active', true)
          .order('updated_at', { ascending: false })
          .limit(100);
        if (error) throw error;
        if (!profiles || profiles.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="ac-subtle" style="padding:16px;">No carts active right now</td></tr>`;
          return;
        }
        const rows = profiles.map((p, idx) => {
          const email = p.email || 'unknown@example.com';
          const lastSeen = p.updated_at ? fmt(p.updated_at) : '—';
          return `
            <tr>
              <td>Cart ${idx + 1} • <span class=\"ac-subtle\">${email}</span></td>
              <td><span class=\"status-pill pill-active\">Active</span></td>
              <td>${lastSeen}</td>
              <td class=\"ac-subtle\">—</td>
              <td>—</td>
            </tr>`;
        }).join('');
        tbody.innerHTML = rows;
      } catch (e) {
        console.error('Failed to load active profiles', e);
        tbody.innerHTML = `<tr><td colspan=\"5\" class=\"ac-subtle\" style=\"padding:16px;\">Failed to load active carts</td></tr>`;
      }
    }

    btn?.addEventListener('click', renderCarts);
    // Re-render when auth state changes (e.g., sign in/out) so status updates live
    try { window.sb?.auth.onAuthStateChange(() => renderCarts()); } catch {}
    renderCarts();
  </script>
</body>
</html>
