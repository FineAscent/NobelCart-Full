<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€¢ Backups</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body class="backup-standalone">
  <style>
    /* Standalone Backup view: centered, white background */
    body.backup-standalone { background: #ffffff; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .bk-wrap { max-width: 980px; width: 100%; padding: 24px 16px; }
    .bk-title { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 16px; }
    .bk-card { background:#ffffff; border:1px solid #e5e7eb; border-radius: 12px; padding:16px; margin-bottom: 14px; }
    .bk-status { margin-top:12px; font-weight: 500; }
    .bk-status.success { color: #059669; }
    .bk-status.error { color: #dc2626; }
    .btn-primary { background: #1f648d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-primary:hover { background: #164e6e; }
    .backup-history { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .backup-history th, .backup-history td { text-align: left; padding: 8px 12px; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
    .backup-history th { color: #6b7280; font-weight: 600; }
  </style>

  <div class="bk-wrap">
    <div class="bk-title" style="display:flex; align-items:center; gap:10px;">
      <span>User Data Backups</span>
      <a href="../admin/index.html" class="btn" style="margin-left:auto; height:28px; padding:4px 10px; display:inline-flex; align-items:center; background:#efefef; border-radius:6px; text-decoration:none; color:#374151;">Back to Home</a>
    </div>

    <div class="bk-card">
      <h3>Create New Backup</h3>
      <p style="color:#6b7280; margin-bottom:16px;">Securely snapshot all user profiles and account data to the backup database.</p>
      <button id="trigger-backup" class="btn-primary">Backup Now</button>
      <div id="backup-status" class="bk-status"></div>
    </div>

    <div class="bk-card">
      <h3>Recent Backups</h3>
      <table class="backup-history">
        <thead>
          <tr>
            <th>Date</th>
            <th>Reason</th>
            <th>Records</th>
            <th>Admin</th>
          </tr>
        </thead>
        <tbody id="backup-list">
          <tr><td colspan="4" style="color:#6b7280; text-align:center; padding: 12px;">Loading history...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config.js"></script>
  
  <!-- Auth Guard -->
  <script>
    (async () => {
      try {
        if (!window.sb) return (window.location.href = '../signin.html?admin=1');
        const { data, error } = await window.sb.auth.getSession();
        const session = data && data.session;
        if (error || !session) {
          try { await window.sb.auth.signOut({ scope: 'local' }); } catch {}
          return (window.location.href = '../signin.html?admin=1');
        }
        // Verify admin role
        const uid = session.user.id;
        const { data: prof } = await window.sb.from('profiles').select('is_admin').eq('id', uid).single();
        if (!prof || !prof.is_admin) {
          alert('Admin access required.');
          return (window.location.href = '../index.html');
        }
      } catch (e) {
        return (window.location.href = '../signin.html?admin=1');
      }
    })();
  </script>

  <!-- Backup Logic -->
  <script>
    const statusEl = document.getElementById('backup-status');
    const listEl = document.getElementById('backup-list');
    const btn = document.getElementById('trigger-backup');

    async function loadHistory() {
      if (!window.sb) return;
      try {
        // Fetch recent unique backup timestamps (grouping isn't native easily, so we just list recent entries or a summary)
        // Since we insert per-row, listing ALL rows is too much. 
        // Ideally we'd have a 'backup_logs' table, but for now let's just show recent individual entries or 
        // maybe we can group by backup_created_at if they are identical.
        // Actually, listing raw entries is fine if volume is low, or we just select distinct times.
        // Supabase select distinct on timestamp might be tricky without a view.
        // Let's just show the last 10 entries for now.
        
        const { data, error } = await window.sb
          .from('profiles_backup')
          .select('*')
          .order('backup_created_at', { ascending: false })
          .limit(10);
          
        if (error) throw error;
        
        if (!data || data.length === 0) {
          listEl.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#6b7280; padding:12px;">No backups found.</td></tr>';
          return;
        }

        listEl.innerHTML = data.map(row => `
          <tr>
            <td>${new Date(row.backup_created_at).toLocaleString()}</td>
            <td>${row.backup_reason || '-'}</td>
            <td>${row.email || 'Unknown User'} (ID: ...${row.original_profile_id.slice(-4)})</td>
            <td>${row.is_admin ? 'Yes' : 'No'}</td>
          </tr>
        `).join('');
        
      } catch (e) {
        console.error(e);
        if (e.code === 'PGRST205' || e.message?.includes('profiles_backup')) {
           listEl.innerHTML = `
             <tr>
               <td colspan="4" style="text-align:center; padding:20px; color:#b91c1c; background:#fef2f2;">
                 <strong>Setup Required:</strong> The backup table does not exist yet.<br/>
                 Please run the SQL migration script in your Supabase Dashboard > SQL Editor.
               </td>
             </tr>`;
        } else {
           listEl.innerHTML = '<tr><td colspan="4" style="color:#dc2626; text-align:center;">Failed to load history. ' + (e.message || '') + '</td></tr>';
        }
      }
    }

    btn.addEventListener('click', async () => {
      if (!window.sb) return;
      btn.disabled = true;
      btn.textContent = 'Backing up...';
      statusEl.textContent = '';
      statusEl.className = 'bk-status';

      try {
        // Call the RPC function
        const { data, error } = await window.sb.rpc('backup_all_profiles', { reason: 'manual_admin_trigger' });
        
        if (error) throw error;

        statusEl.textContent = `Success! ${data} profiles backed up.`;
        statusEl.className = 'bk-status success';
        loadHistory();
      } catch (e) {
        console.error(e);
        if (e.code === 'PGRST202' || e.message?.includes('backup_all_profiles')) {
          statusEl.innerHTML = `<strong>Setup Required:</strong> The 'backup_all_profiles' function is missing.<br/>Please run the SQL migration script in Supabase.`;
          statusEl.className = 'bk-status error';
        } else {
          statusEl.textContent = 'Backup failed: ' + (e.message || 'Unknown error');
          statusEl.className = 'bk-status error';
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Backup Now';
      }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
</body>
</html>
