<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • Monitor Active Carts</title>
  <link rel="stylesheet" href="../styles.css" />
</head>
<body class="refunds-standalone">
  <style>
    /* Reuse the centered card layout from refunds */
    body.refunds-standalone { background: #f7fafc; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .mon-wrap { max-width: 980px; width: 100%; padding: 24px 16px; }
    .mon-title { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 16px; }
    .mon-card { background:#ffffff; border:1px solid #e5e7eb; border-radius: 12px; padding:16px; }
    .mon-card + .mon-card { margin-top: 14px; }
    .mon-status { margin-top:8px; color:#6b7280; }
    .mon-table { width: 100%; border-collapse: collapse; }
    .mon-table th, .mon-table td { text-align:left; padding:10px 12px; border-bottom:1px solid #e5e7eb; }
    .mon-actions .btn { background:#efefef; border:1px solid #e5e7eb; padding:6px 10px; border-radius: 8px; cursor:pointer; }
    .mon-actions .btn:hover { background:#e9e9e9; }
  </style>

  <div class="mon-wrap">
    <div class="mon-title">Monitor Active Carts</div>

    <div class="mon-card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;">
        <div id="mon-summary" style="font-weight:700;">No active carts</div>
        <button id="mon-refresh" class="btn">Refresh</button>
      </div>
      <table class="mon-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Subtotal</th>
            <th>Updated</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="mon-rows">
          <tr><td colspan="5" style="padding:16px; color:#6b7280;">Coming soon: live list of authenticated customers and their active cart totals.</td></tr>
        </tbody>
      </table>
      <div class="mon-status" id="mon-status"></div>
    </div>
  </div>

  <!-- Supabase (auth + functions) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config.js"></script>
  <!-- Guard admin page behind login -->
  <script>
    (async () => {
      try {
        if (!window.sb) return (window.location.href = '../signin.html');
        const { data, error } = await window.sb.auth.getSession();
        const session = data && data.session;
        if (error || !session) {
          try { await window.sb.auth.signOut({ scope: 'local' }); } catch {}
          return (window.location.href = '../signin.html');
        }
      } catch (e) {
        try { await window.sb.auth.signOut({ scope: 'local' }); } catch {}
        return (window.location.href = '../signin.html');
      }
    })();
  </script>
  <!-- Placeholder wiring (to be implemented: realtime carts feed) -->
  <script>
    (function(){
      const refreshBtn = document.getElementById('mon-refresh');
      const rows = document.getElementById('mon-rows');
      const status = document.getElementById('mon-status');
      const summary = document.getElementById('mon-summary');

      function fmtMoney(cents){
        const c = Number(cents)||0; return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(c/100);
      }
      function fmtWhen(iso){
        if(!iso) return '';
        try{ return new Intl.DateTimeFormat(undefined,{dateStyle:'medium',timeStyle:'short'}).format(new Date(iso)); }catch{ return iso; }
      }

      async function endSession(user_id, client_id){
        if (!window.sb) return;
        try {
          await window.sb.from('active_carts').update({ status: 'inactive', updated_at: new Date().toISOString() })
            .eq('user_id', user_id).eq('client_id', client_id);
        } catch (e) {
          console.error('Failed to end session', e);
        }
      }

      async function refresh() {
        status.textContent = 'Loading...';
        rows.innerHTML = '';
        try {
          if (!window.sb) throw new Error('No supabase');
          const { data, error } = await window.sb
            .from('active_carts')
            .select('user_id, email, subtotal_cents, updated_at, status, client_id')
            .eq('status','active')
            .order('updated_at', { ascending: false });
          if (error) throw error;
          const items = Array.isArray(data)?data:[];
          if (!items.length){
            summary.textContent = 'No active carts';
            rows.innerHTML = '<tr><td colspan="5" style="padding:16px; color:#6b7280;">No active carts.</td></tr>';
          } else {
            summary.textContent = `${items.length} active ${items.length===1?'cart':'carts'}`;
            for (const r of items){
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${r.user_id ? r.user_id.slice(0,8)+'…' : ''}</td>
                <td>${r.email || ''}</td>
                <td>${fmtMoney(r.subtotal_cents)}</td>
                <td>${fmtWhen(r.updated_at)}</td>
                <td class="mon-actions"><button class="btn" data-user="${r.user_id}" data-client="${r.client_id}">End</button></td>
              `;
              rows.appendChild(tr);
            }
          }
          status.textContent='';
        } catch (e) {
          console.error(e);
          status.textContent = 'Failed to load active carts';
        }
      }

      // Button actions
      document.addEventListener('click', (e) => {
        const btn = e.target && e.target.closest && e.target.closest('.mon-actions .btn');
        if (!btn || !rows.contains(btn)) return;
        const user_id = btn.getAttribute('data-user');
        const client_id = btn.getAttribute('data-client');
        endSession(user_id, client_id);
      });

      // Realtime subscription for live updates
      try {
        if (window.sb && window.sb.channel) {
          const channel = window.sb.channel('active-carts-live')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'active_carts' }, (payload) => {
              refresh();
            })
            .subscribe();
        }
      } catch(_){}

      if (refreshBtn) refreshBtn.addEventListener('click', refresh);
      // initial
      refresh();
    })();
  </script>
</body>
</html>
