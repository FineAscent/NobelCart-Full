<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin • Active Sessions</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    body.refunds-standalone { background: #f7fafc; min-height: 100vh; }
    .admin-wrap { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }
    .admin-title { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 16px; display:flex; align-items:center; gap:12px; }
    .session-toolbar { display:flex; gap:8px; align-items:center; margin-bottom: 12px; }
    .session-grid { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
    .session-grid th, .session-grid td { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; text-align: left; font-size: 14px; }
    .session-grid th { background: #f9fafb; font-weight: 600; color: #374151; }
    .muted { color: #6b7280; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size:12px; background:#eef2ff; color:#3730a3; }
    .btn { border: 1px solid #d1d5db; background: #fff; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .btn:hover { background: #f9fafb; }
    .btn-danger { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
    .btn-danger:hover { background: #fecaca; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body class="refunds-standalone">
  <style>
    /* Standalone centered with white background */
    body.refunds-standalone { background: #ffffff; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .admin-wrap { max-width: 1200px; width: 100%; padding: 24px 16px; }
  </style>
  <div class="admin-wrap">
    <div class="admin-title" style="display:flex; align-items:center; gap:10px;">
      <a class="btn" href="index.html" style="height:28px; padding:4px 10px; display:inline-flex; align-items:center;">Admin</a>
      <span>Active Sessions</span>
    </div>

    <div class="session-toolbar">
      <button id="refresh" class="btn">Refresh</button>
      <label class="muted">Auto-refresh <input id="autorefresh" type="checkbox" checked /></label>
      <span class="muted" id="status">—</span>
    </div>

    <div style="overflow-x:auto;">
      <table class="session-grid" id="grid">
        <thead>
          <tr>
            <th>User</th>
            <th>Device</th>
            <th class="right">Subtotal</th>
            <th>Last Seen</th>
            <th>UA</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../config.js"></script>
  <script>
    // Route guard: require active session and admin role
    (async () => {
      try {
        if (!window.sb) return (window.location.href = '../signin.html');
        const { data, error } = await window.sb.auth.getSession();
        const session = data && data.session;
        if (error || !session) {
          try { await window.sb.auth.signOut({ scope: 'local' }); } catch {}
          return (window.location.href = '../signin.html');
        }
        const uid = session.user.id;
        const { data: prof } = await window.sb.from('profiles').select('is_admin, email').eq('id', uid).single();
        if (!prof || !prof.is_admin) {
          alert('Admin access required.');
          return (window.location.href = '../index.html');
        }
      } catch (e) {
        try { await window.sb.auth.signOut({ scope: 'local' }); } catch {}
        return (window.location.href = '../signin.html');
      }
    })();
  </script>
  <script>
    const fmt = (n) => '$' + (Number(n||0).toFixed(2));
    const el = (id) => document.getElementById(id);

    async function loadSessions() {
      const status = el('status');
      status.textContent = 'Loading…';
      try {
        // Only consider sessions that have heartbeated recently (last 2 minutes)
        const nowMinus2Min = new Date(Date.now() - 2 * 60 * 1000).toISOString();
        const { data, error } = await window.sb
          .from('active_sessions')
          .select('*')
          .gte('last_seen', nowMinus2Min)
          .order('last_seen', { ascending: false });
        if (error) throw error;
        // Deduplicate by user (keep the most recent row per user_id)
        const rows = Array.isArray(data) ? data : [];
        const byUser = new Map();
        for (const r of rows) {
          if (!byUser.has(r.user_id)) {
            byUser.set(r.user_id, { ...r, __device_count: 1 });
          } else {
            // Increment device count for this user; keep the first (most recent) row
            const cur = byUser.get(r.user_id);
            cur.__device_count = (cur.__device_count || 1) + 1;
          }
        }
        renderRows(Array.from(byUser.values()));
        status.textContent = 'Updated ' + new Date().toLocaleTimeString();
      } catch (e) {
        console.error(e);
        status.textContent = 'Error loading sessions';
      }
    }

    function renderRows(rows) {
      const tb = el('tbody');
      if (!rows.length) {
        tb.innerHTML = '<tr><td colspan="6" class="muted">No active sessions.</td></tr>';
        return;
      }
      tb.innerHTML = rows.map(r => {
        const last = new Date(r.last_seen).toLocaleTimeString();
        const ua = (r.user_agent || '').slice(0, 48).replace(/</g,'&lt;');
        const email = (r.email || '').replace(/</g,'&lt;');
        const deviceTxt = (r.__device_count && r.__device_count > 1)
          ? `${r.__device_count} devices`
          : r.device_id;
        return `
          <tr data-user-id="${r.user_id}" data-device-id="${r.device_id}">
            <td class="nowrap">${email || '<span class="muted">(no email)</span>'}</td>
            <td><span class="pill">${deviceTxt}</span></td>
            <td class="right">${fmt(r.subtotal)}</td>
            <td class="nowrap">${last}</td>
            <td class="nowrap muted" title="${(r.user_agent||'').replace(/"/g,'&quot;')}">${ua}</td>
            <td>
              <button class="btn btn-danger" onclick="forceSignOut('${r.user_id}','${r.device_id}')">Force Sign-out</button>
              <button class="btn" onclick="signOutAll('${r.user_id}')">Sign out all</button>
            </td>
          </tr>`;
      }).join('');
    }

    async function forceSignOut(userId, deviceId) {
      try {
        const { error } = await window.sb
          .from('active_sessions')
          .update({ force_sign_out: true })
          .eq('user_id', userId)
          .eq('device_id', deviceId);
        if (error) throw error;
        await loadSessions();
      } catch (e) {
        alert('Failed to force sign-out: ' + (e.message || e));
      }
    }

    async function signOutAll(userId) {
      try {
        const { error } = await window.sb
          .from('active_sessions')
          .update({ force_sign_out: true })
          .eq('user_id', userId);
        if (error) throw error;
        await loadSessions();
      } catch (e) {
        alert('Failed to sign out all: ' + (e.message || e));
      }
    }

    // Wire UI
    window.forceSignOut = forceSignOut;
    window.signOutAll = signOutAll;
    document.getElementById('refresh').addEventListener('click', loadSessions);
    const auto = document.getElementById('autorefresh');
    let timer = null;
    auto.addEventListener('change', () => {
      if (auto.checked) startAuto(); else stopAuto();
    });
    function startAuto() {
      stopAuto();
      timer = setInterval(loadSessions, 5000);
    }
    function stopAuto() { if (timer) { clearInterval(timer); timer = null; } }

    // Initial load
    (async () => {
      await loadSessions();
      startAuto();
    })();
  </script>
</body>
</html>
